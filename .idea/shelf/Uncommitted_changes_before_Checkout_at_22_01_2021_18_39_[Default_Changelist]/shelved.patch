Index: app/src/main/java/ru/mvlikhachev/stopdrink/view/MainActivity.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package ru.mvlikhachev.stopdrink.view;\r\n\r\nimport android.content.Context;\r\nimport android.content.Intent;\r\nimport android.content.SharedPreferences;\r\nimport android.os.Bundle;\r\nimport android.util.Log;\r\nimport android.view.Menu;\r\nimport android.view.MenuInflater;\r\nimport android.view.MenuItem;\r\nimport android.view.View;\r\nimport android.widget.ImageView;\r\nimport android.widget.TextView;\r\nimport android.widget.Toast;\r\n\r\nimport androidx.annotation.NonNull;\r\nimport androidx.appcompat.app.AppCompatActivity;\r\nimport androidx.core.app.NotificationManagerCompat;\r\nimport androidx.lifecycle.LiveData;\r\nimport androidx.lifecycle.ViewModelProvider;\r\n\r\nimport com.google.android.gms.ads.AdListener;\r\nimport com.google.android.gms.ads.AdRequest;\r\nimport com.google.android.gms.ads.AdView;\r\nimport com.google.android.gms.ads.InterstitialAd;\r\nimport com.google.android.gms.ads.MobileAds;\r\nimport com.google.android.material.bottomnavigation.BottomNavigationView;\r\nimport com.google.firebase.auth.FirebaseAuth;\r\nimport com.google.firebase.auth.FirebaseUser;\r\nimport com.google.firebase.database.DatabaseReference;\r\nimport com.google.firebase.database.FirebaseDatabase;\r\n\r\nimport ru.mvlikhachev.stopdrink.R;\r\nimport ru.mvlikhachev.stopdrink.Utils.NotificationReceiver;\r\nimport ru.mvlikhachev.stopdrink.Utils.Utils;\r\nimport ru.mvlikhachev.stopdrink.model.User;\r\nimport ru.mvlikhachev.stopdrink.view.viewmodel.MainActivityViewModel;\r\n\r\nimport static ru.mvlikhachev.stopdrink.Utils.Utils.goOfflineConnectiontoDatabase;\r\nimport static ru.mvlikhachev.stopdrink.Utils.Utils.goOnlineConnectiontoDatabase;\r\n\r\npublic class MainActivity extends AppCompatActivity {\r\n\r\n    //////////////////////// Constants ////////////////////////////////////\r\n    // Константа файла сохранения настроек\r\n    public static final String APP_PREFERENCES = \"datasetting\";\r\n    public static final String APP_PREFERENCES_KEY_NAME = \"nameFromDb\";\r\n    public static final String APP_PREFERENCES_KEY_DATE = \"dateFromDb\";\r\n    ////////////////////// INITIALIZATION /////////////////////////////////\r\n    private TextView helloUsernameTextView;\r\n    private TextView daysTextView;\r\n    private TextView timeTextView;\r\n    private ImageView logoImageView;\r\n    ///////////////////////// DATA ////////////////////////////////////\r\n    private String username;\r\n    private String lastDrinkDate;\r\n    private String userId;\r\n    private String daysWithoutDrink;\r\n    ////////////////////////// FIREBASE ///////////////////////////////\r\n    private FirebaseDatabase database;\r\n    private DatabaseReference userDatabaseReference;\r\n\r\n    private FirebaseAuth auth;\r\n    private FirebaseUser firebaseUser;\r\n\r\n    // AdMob\r\n    private AdView mAdView;\r\n    private InterstitialAd mInterstitialAd;\r\n    ///////////////////////////////////////////////////////////////////\r\n    private SharedPreferences sharedPreferences;\r\n    private SharedPreferences.Editor editor;\r\n///////////////////////////////////////////////////////////////////\r\n\r\n    private NotificationManagerCompat notificationManager;\r\n\r\n    //\r\n    private MainActivityViewModel mainActivityViewModel;\r\n\r\n\r\n    // TEST\r\n\r\n    private FirebaseAuth mAuth;\r\n    private DatabaseReference myRef;\r\n\r\n    @Override\r\n    protected void onCreate(Bundle savedInstanceState) {\r\n        super.onCreate(savedInstanceState);\r\n        setContentView(R.layout.activity_main);\r\n\r\n        // AdMob\r\n        showAdMob();\r\n\r\n///////// Initialization block\r\n        mainActivityViewModel = new ViewModelProvider\r\n                .AndroidViewModelFactory(getApplication())\r\n                .create(MainActivityViewModel.class);\r\n\r\n//        User testUser = new User();\r\n//        testUser.setUid(\"2\");\r\n//        testUser.setName(\"Anton\");\r\n//        mainActivityViewModel.addNewUser(testUser);\r\n//\r\n//        mainActivityViewModel.getUser(\"2\").observe(this, user -> {\r\n//            Log.d(\"TAGUSER\", \"Add: \" + user.getName());\r\n//        });\r\n//\r\n//        testUser.setName(\"Ne Anton\");\r\n//        mainActivityViewModel.updateUser(testUser);\r\n//\r\n//        mainActivityViewModel.getUser(\"2\").observe(this, user -> Log.d(\"TAGUSER\", \"Update: \" + user.getName()));\r\n\r\n\r\n        helloUsernameTextView = findViewById(R.id.helloUsernameTextView);\r\n        daysTextView = findViewById(R.id.daysTextView);\r\n        timeTextView = findViewById(R.id.timeTextView);\r\n        logoImageView = findViewById(R.id.logoImageView);\r\n\r\n        sharedPreferences = this.getSharedPreferences(APP_PREFERENCES, Context.MODE_PRIVATE);\r\n        editor = sharedPreferences.edit();\r\n\r\n        auth = FirebaseAuth.getInstance();\r\n        firebaseUser = auth.getCurrentUser();\r\n\r\n        database = FirebaseDatabase.getInstance();\r\n        userDatabaseReference = database.getReference().child(\"users\");\r\n\r\n\r\n        username = \"\";\r\n        lastDrinkDate = \"2000/01/01 00:00:00\";\r\n        userId = Utils.getUserId();\r\n        daysWithoutDrink = \"0\";\r\n\r\n//////// End initialization block\r\n\r\n        // Если не авторизованы - идев в активити авторизации\r\n        if (auth.getCurrentUser() == null) {\r\n            startActivity(new Intent(MainActivity.this, LoginSignUpActivity.class));\r\n        }\r\n\r\n        goOnlineConnectiontoDatabase();\r\n        if (Utils.hasConnection(this)) {\r\n\r\n            loadData(firebaseUser.getUid());\r\n\r\n            // load last date when user drink alcohol from firebase database\r\n            Thread updateDateThread = new Thread(() -> {\r\n                while(true){\r\n                    try {\r\n                        setTime();\r\n                        Thread.sleep(60000); //1000 - 1 сек\r\n                    } catch (InterruptedException ex) {\r\n                        ex.printStackTrace();\r\n                    }\r\n                }\r\n            });\r\n            updateDateThread.start();\r\n\r\n        } else {\r\n            username = sharedPreferences.getString(APP_PREFERENCES_KEY_NAME,\r\n                    \"Default Name\");\r\n            lastDrinkDate = sharedPreferences.getString(APP_PREFERENCES_KEY_DATE,\r\n                    \"2000/01/01 00:00:00\");\r\n            Toast.makeText(this, \"Для работы приложения нужен доступ в интернет\", Toast.LENGTH_LONG).show();\r\n        }\r\n        notificationManager = NotificationManagerCompat.from(this);\r\n\r\n\r\n        logoImageView.setOnLongClickListener(v -> {\r\n\r\n            NotificationReceiver.createNotificationChannel(this);\r\n            NotificationReceiver.showNotification(this, daysWithoutDrink);\r\n\r\n            return false;\r\n        });\r\n        showBottomNavigation(R.id.main_page);\r\n    }\r\n\r\n    private void loadData(String uid) {\r\n        mainActivityViewModel.getUser(uid).observe(this, user -> {\r\n            helloUsernameTextView.setText(\"Здраствуйте, \" + user.getName());\r\n            lastDrinkDate = user.getDateWhenStopDrink();\r\n\r\n            setTime();\r\n\r\n        });\r\n    }\r\n\r\n    private void setTime() {\r\n        String[] dates = Utils.calculateTimeWithoutDrink(lastDrinkDate);\r\n        daysWithoutDrink = dates[0];\r\n        setNotDrinkTime(dates[0],dates[1],dates[2]);\r\n\r\n        // Show notification if hour = 00 and minute = 00\r\n        if (dates[1].equals(\"00\") && dates[2].equals(\"00\")) {\r\n            Utils.showNotificationWithDate(getApplicationContext(),dates[0]);\r\n        }\r\n    }\r\n\r\n    // Set date data in TextView\r\n    private void setNotDrinkTime(String days, String hours, String minutes) {\r\n        daysTextView.setText(days + \" дней\");\r\n        timeTextView.setText(hours + \":\" + minutes);\r\n    }\r\n    LiveData<User> getUser() {\r\n        return mainActivityViewModel.getUser(firebaseUser.getUid());\r\n    }\r\n\r\n    // Button \"сбросить\"\r\n    public void resetDrinkDate(View view) {\r\n        if (Utils.hasConnection(this)) {\r\n\r\n            String updateDate = Utils.getCurrentDate();\r\n            String[] dates = Utils.calculateTimeWithoutDrink(updateDate);\r\n            daysWithoutDrink = dates[0];\r\n            setNotDrinkTime(dates[0],dates[1],dates[2]);\r\n\r\n            LiveData<User> cUser = mainActivityViewModel.getUser(firebaseUser.getUid());\r\n\r\n            mainActivityViewModel.getUser(firebaseUser.getUid()).observe(this, user -> {\r\n\r\n                if (!user.getDateWhenStopDrink().equals(updateDate)) {\r\n                    user.setDateWhenStopDrink(updateDate);\r\n                }\r\n            });\r\n\r\n            // Show notification if hour = 00 and minute = 00\r\n            if (dates[1].equals(\"00\") && dates[2].equals(\"00\")) {\r\n                Utils.showNotificationWithDate(getApplicationContext(),dates[0]);\r\n            }\r\n        }\r\n    }\r\n\r\n    // Show bottom navighation menu\r\n    private void showBottomNavigation(int currentMenu) {\r\n        BottomNavigationView bottomNavigationView = findViewById(R.id.bottomNavigationView);\r\n        bottomNavigationView.setSelectedItemId(currentMenu);\r\n        bottomNavigationView.setOnNavigationItemSelectedListener(item -> {\r\n            switch (item.getItemId()) {\r\n                case R.id.profile_page:\r\n                    startActivity(new Intent(getApplicationContext(),\r\n                            ProfileActivity.class));\r\n                    overridePendingTransition(0, 0);\r\n                    return true;\r\n                case R.id.main_page:\r\n                    startActivity(new Intent(getApplicationContext(),\r\n                            MainActivity.class));\r\n                    overridePendingTransition(0, 0);\r\n                    return true;\r\n            }\r\n            return false;\r\n        });\r\n    }\r\n\r\n    // AdMob show AD method\r\n    private void showAdMob() {\r\n        Log.d(\"AdMob\", \"AdMob run...\");\r\n        MobileAds.initialize(this, initializationStatus -> {\r\n        });\r\n\r\n        mAdView = new AdView(this);\r\n\r\n        mAdView = findViewById(R.id.adViewBottom);\r\n        AdRequest adRequest = new AdRequest.Builder()\r\n                .addTestDevice(\"D831A2241D7E1E3B316D46B94FAEE642\")\r\n                .addTestDevice(AdRequest.DEVICE_ID_EMULATOR)\r\n                .build();\r\n        mAdView.loadAd(adRequest);\r\n\r\n        mInterstitialAd = new InterstitialAd(this);\r\n        mInterstitialAd.setAdUnitId(\"ca-app-pub-3120800894638034/9851550730\");\r\n        mInterstitialAd.loadAd(new AdRequest.Builder().build());\r\n\r\n        mInterstitialAd.setAdListener(new AdListener() {\r\n            @Override\r\n            public void onAdClosed() {\r\n                // Load the next interstitial.\r\n                mInterstitialAd.loadAd(new AdRequest.Builder().build());\r\n            }\r\n\r\n        });\r\n    }\r\n\r\n    @Override\r\n    public boolean onCreateOptionsMenu(Menu menu) {\r\n        MenuInflater inflater = getMenuInflater();\r\n        inflater.inflate(R.menu.main_menu, menu);\r\n        return true;\r\n    }\r\n\r\n    public boolean onOptionsItemSelected(@NonNull MenuItem item) {\r\n        // Если пользователь авторизован - сразу открыть мэйн активити\r\n        if (auth.getCurrentUser() != null) {\r\n            switch (item.getItemId()) {\r\n                case R.id.sign_out:\r\n                    Intent intent = new Intent(this, LoginSignUpActivity.class);\r\n                    intent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);\r\n                    startActivity(intent);\r\n                    finish();\r\n                    FirebaseAuth.getInstance().signOut();\r\n                    return true;\r\n                case R.id.about_program:\r\n                    startActivity(new Intent(MainActivity.this, AboutActivity.class));\r\n                    return true;\r\n                case R.id.settings_programm:\r\n                    Intent intentSettings = new Intent(MainActivity.this, SettingActivity.class);\r\n                    intentSettings.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);\r\n                    startActivity(intentSettings);\r\n                    return true;\r\n                default:\r\n                    return super.onOptionsItemSelected(item);\r\n            }\r\n        }\r\n        return super.onOptionsItemSelected(item); // хз зачем, но без нее не работает\r\n    }\r\n\r\n\r\n    @Override\r\n    protected void onResume() {\r\n        super.onResume();\r\n        mAdView.resume();\r\n\r\n        setTime();\r\n        goOnlineConnectiontoDatabase();\r\n\r\n        if (mInterstitialAd.isLoaded()) {\r\n            mInterstitialAd.show();\r\n        } else {\r\n            Log.d(\"TAGG\", \"The interstitial wasn't loaded yet.\");\r\n        }\r\n    }\r\n\r\n    @Override\r\n    public void onPause() {\r\n        mAdView.pause();\r\n\r\n        super.onPause();\r\n\r\n        goOfflineConnectiontoDatabase();\r\n    }\r\n\r\n\r\n    @Override\r\n    protected void onDestroy() {\r\n        mAdView.destroy();\r\n\r\n        goOfflineConnectiontoDatabase();\r\n\r\n        super.onDestroy();\r\n    }\r\n\r\n    @Override\r\n    protected void onStart() {\r\n        super.onStart();\r\n\r\n    }\r\n}
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- app/src/main/java/ru/mvlikhachev/stopdrink/view/MainActivity.java	(revision 198e19145716f699b2c6a091986265ef3fe4f3a5)
+++ app/src/main/java/ru/mvlikhachev/stopdrink/view/MainActivity.java	(date 1603955291570)
@@ -17,6 +17,7 @@
 import androidx.appcompat.app.AppCompatActivity;
 import androidx.core.app.NotificationManagerCompat;
 import androidx.lifecycle.LiveData;
+import androidx.lifecycle.Observer;
 import androidx.lifecycle.ViewModelProvider;
 
 import com.google.android.gms.ads.AdListener;
@@ -76,6 +77,8 @@
     //
     private MainActivityViewModel mainActivityViewModel;
 
+    private Observer observer;
+
 
     // TEST
 
@@ -222,6 +225,7 @@
                     user.setDateWhenStopDrink(updateDate);
                 }
             });
+            
 
             // Show notification if hour = 00 and minute = 00
             if (dates[1].equals("00") && dates[2].equals("00")) {
